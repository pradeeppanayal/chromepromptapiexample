<!DOCTYPE html>
<html>

<head>
    <title>AI Chat</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            height: 100vh;
            font-family: Arial, sans-serif;
            background: #ece5dd;
        }

        #chatContainer {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #chat {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #efeae2;
        }

        .message {
            max-width: 70%;
            padding: 10px 14px;
            margin-bottom: 10px;
            border-radius: 10px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .user {
            background: #d9fdd3;
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }

        .ai {
            background: #ffffff;
            margin-right: auto;
            border-bottom-left-radius: 2px;
        }

        #inputBox {
            display: flex;
            padding: 10px;
            background: #f0f0f0;
            border-top: 1px solid #ddd;
        }

        #promptInput {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border-radius: 20px;
            border: 1px solid #ccc;
            outline: none;
        }

        #sendBtn {
            margin-left: 10px;
            padding: 10px 18px;
            border-radius: 20px;
            border: none;
            background: #008069;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        #sendBtn:disabled {
            background: #9e9e9e;
            cursor: not-allowed;
        }

        .typing {
            display: inline-flex;
            gap: 4px;
            align-items: center;
        }

        .typing span {
            width: 6px;
            height: 6px;
            background: #555;
            border-radius: 50%;
            animation: blink 1.4s infinite both;
        }

        .typing span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0% {
                opacity: 0.2;
            }

            20% {
                opacity: 1;
            }

            100% {
                opacity: 0.2;
            }
        }
    </style>

</head>

<body>

    <div id="chatContainer">
        <div id="chat"></div>

        <div id="inputBox">
            <input id="promptInput" placeholder="Type your message..." />
            <button id="sendBtn" onclick="sendPrompt()">Send</button>
        </div>
    </div>

    <script>
        let session;
        let waitingForResponse = false;

        async function initModel() {
            if (!self.LanguageModel) {
                alert("Chrome Prompt API not available");
                return;
            }

            session = await self.LanguageModel.create({
                systemPrompt: "You are a helpful assistant.",
                outputLanguage: "en"
            });
        }

        async function sendPrompt() {
            if (waitingForResponse) return;

            const input = document.getElementById("promptInput");
            const sendBtn = document.getElementById("sendBtn");
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, "user");
            input.value = "";

            waitingForResponse = true;
            input.disabled = true;
            sendBtn.disabled = true;

            showTypingIndicator(); // ðŸ‘ˆ show dots

            try {
                if (!session) {
                    await initModel();
                }

                const response = await session.prompt(text);

                removeTypingIndicator(); // ðŸ‘ˆ remove dots
                addMessage(response, "ai");

            } catch (err) {
                removeTypingIndicator();
                addMessage("Something went wrong.", "ai");
                console.error(err);
            }

            waitingForResponse = false;
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }


        function addMessage(text, type) {
            const chat = document.getElementById("chat");
            const div = document.createElement("div");
            div.className = `message ${type}`;
            div.innerHTML = formatMessage(text); // ðŸ‘ˆ important change
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }
        function formatMessage(text) {
            // Escape HTML first (important for safety)
            const escaped = text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");

            // Convert **bold** â†’ <strong>bold</strong>
            return escaped.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        }
        // Send on Enter key
        document.getElementById("promptInput").addEventListener("keydown", e => {
            if (e.key === "Enter") sendPrompt();
        });
        function showTypingIndicator() {
            const chat = document.getElementById("chat");
            const div = document.createElement("div");
            div.className = "message ai";
            div.id = "typingIndicator";
            div.innerHTML = `
    <div class="typing">
      <span></span><span></span><span></span>
    </div>
  `;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function removeTypingIndicator() {
            const typing = document.getElementById("typingIndicator");
            if (typing) typing.remove();
        }

    </script>


</body>

</html>